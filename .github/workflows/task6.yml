name: Task 6 â€“ Blue Green with Nginx Reverse Proxy

on:
  push:
    branches:
      - main
    paths:
      - task6/**

env:
  APP_NAME: task6
  IMAGE: task6-website
  NETWORK: task6-net
  NGINX: task6-nginx

jobs:
  deploy:
    runs-on: [self-hosted, docker]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Docker network exists
        shell: bash
        run: |
          docker network inspect ${{ env.NETWORK }} >/dev/null 2>&1 || \
          docker network create ${{ env.NETWORK }}

      - name: Decide deployment color
        shell: bash
        run: |
          if docker ps --format '{{.Names}}' | grep -q "${{ env.APP_NAME }}-blue"; then
            echo "COLOR=green" >> $GITHUB_ENV
            echo "OLD_COLOR=blue" >> $GITHUB_ENV
          else
            echo "COLOR=blue" >> $GITHUB_ENV
            echo "OLD_COLOR=green" >> $GITHUB_ENV
          fi

      - name: Build application image
        shell: bash
        run: |
          docker build -t ${{ env.IMAGE }}:latest task6

      - name: Start new application container
        shell: bash
        run: |
          docker rm -f ${{ env.APP_NAME }}-${{ env.COLOR }} || true
          docker run -d \
            --network ${{ env.NETWORK }} \
            --name ${{ env.APP_NAME }}-${{ env.COLOR }} \
            ${{ env.IMAGE }}:latest

      - name: Wait for new container to be ready
        shell: bash
        run: |
          echo "Waiting for application to become ready..."
          for i in {1..20}; do
            if docker exec ${{ env.APP_NAME }}-${{ env.COLOR }} wget -qO- http://localhost:80 >/dev/null 2>&1; then
              echo "Application is ready"
              exit 0
            fi
            sleep 1
          done
          echo "Application did not become ready in time"
          exit 1

      - name: Switch active container (zero downtime)
        shell: bash
        run: |
          docker rm -f ${{ env.APP_NAME }}-active || true
          docker rename ${{ env.APP_NAME }}-${{ env.COLOR }} ${{ env.APP_NAME }}-active

      - name: Ensure nginx reverse proxy is running (zero downtime + no 502)
        shell: bash
        run: |
          if docker ps --format '{{.Names}}' | grep -q "${{ env.NGINX }}"; then
            echo "nginx already running"
          else
            docker run -d \
              --network ${{ env.NETWORK }} \
              -p 8080:80 \
              --name ${{ env.NGINX }} \
              --entrypoint sh \
              nginx:alpine \
              -c 'cat <<EOF >/etc/nginx/conf.d/default.conf
              resolver 127.0.0.11 valid=5s;

              server {
                listen 80;

                location / {
                  set \$backend task6-active;
                  proxy_pass http://\$backend:80;

                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                }
              }
              EOF
              nginx -g "daemon off;"'
                        fi

      - name: Remove old application container
        shell: bash
        run: |
          docker rm -f ${{ env.APP_NAME }}-${{ env.OLD_COLOR }} || true
