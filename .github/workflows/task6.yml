name: Task 6

on:
  push:
    branches:
      - main
    paths:
      - task6/**

env:
  APP_NAME: task6
  IMAGE: task6-website
  NETWORK: task6-net
  NGINX: task6-nginx

jobs:
  deploy:
    runs-on: [self-hosted, docker]

    steps:
      - uses: actions/checkout@v4

      - run: docker network inspect ${{ env.NETWORK }} || docker network create ${{ env.NETWORK }}

      - run: |
          if docker ps --format '{{.Names}}' | grep -q task6-blue; then
            echo "COLOR=green" >> $GITHUB_ENV
            echo "OLD_COLOR=blue" >> $GITHUB_ENV
          else
            echo "COLOR=blue" >> $GITHUB_ENV
            echo "OLD_COLOR=green" >> $GITHUB_ENV
          fi

      - run: docker build -t task6-website task6

      - run: |
          docker rm -f task6-${{ env.COLOR }} || true
          docker run -d --network task6-net --name task6-${{ env.COLOR }} task6-website

      - run: |
          mkdir -p nginx
          cat > nginx/nginx.conf <<EOF
          user nginx;
          events {}

          http {
            server {
              listen 80;
              location / {
                proxy_pass http://task6-${{ env.COLOR }}:80;
              }
            }
          }
          EOF

      - run: |
          docker rm -f task6-nginx || true
          docker run -d \
            --network task6-net \
            -p 8080:80 \
            -v $PWD/nginx/nginx.conf:/tmp/nginx.conf:ro \
            --entrypoint nginx \
            --name task6-nginx \
            nginx:alpine \
            -c /tmp/nginx.conf -g 'daemon off;'

      - run: docker rm -f task6-${{ env.OLD_COLOR }} || true
